---
import RecordLayout from '../../layouts/Record.astro';
import MetadataTable from '../../components/MetadataTable.astro';
import DownloadButtons from '../../components/DownloadButtons.astro';
import BadgeQuality from '../../components/BadgeQuality.astro';
import CitationBox from '../../components/CitationBox.astro';
import PdfViewer from '../../components/PdfViewer.astro';
import { buildBookJsonLd } from '../../lib/schema';
import { Fragment } from 'astro/jsx-runtime';

const { id } = Astro.params;
const entries = await Astro.glob('../../_records/*.md');
const record = entries.find((entry) => entry.frontmatter.record_id === id);

if (!record) {
  throw new Error(`Record ${id} not found`);
}

const { frontmatter, Content } = record;
const metadata = {
  'Creators': frontmatter.creators,
  'Date': String(frontmatter.date),
  'Language': frontmatter.language,
  'Subjects': frontmatter.subjects,
  'Collection': frontmatter.collection,
  'Rights': frontmatter.rights,
  'Source': frontmatter.source_url
};

const jsonLd = buildBookJsonLd({
  id: frontmatter.record_id,
  title: frontmatter.title,
  creators: frontmatter.creators,
  date: frontmatter.date,
  language: frontmatter.language,
  description: undefined,
  downloadHtml: frontmatter.downloads?.html ?? null,
  downloadPdf: frontmatter.downloads?.pdf ?? null,
  downloadEpub: frontmatter.downloads?.epub ?? null,
  url: frontmatter.identifiers?.permalink ?? `/record/${frontmatter.record_id}`
});
---
<RecordLayout>
  <Fragment slot="head">
    <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
  </Fragment>
  <header class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
    <div class="space-y-4">
      <h1 class="text-4xl font-bold tracking-tight text-slate-900 dark:text-white">{frontmatter.title}</h1>
      <p class="text-lg text-slate-600 dark:text-slate-300">{frontmatter.creators.join(', ')}</p>
      {frontmatter.quality_grade ? <BadgeQuality grade={frontmatter.quality_grade} /> : null}
    </div>
    <DownloadButtons downloads={frontmatter.downloads} />
  </header>
  <section class="mt-10 grid gap-8 lg:grid-cols-[minmax(0,1fr)_320px]">
    <div class="space-y-8">
      <PdfViewer src={frontmatter.downloads?.pdf} />
      <article class="prose dark:prose-invert">
        <Content />
      </article>
    </div>
    <aside class="space-y-6">
      <MetadataTable metadata={metadata} />
      <CitationBox {...frontmatter.citation} />
    </aside>
  </section>
</RecordLayout>
