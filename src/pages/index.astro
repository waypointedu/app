---
import Base from '../layouts/Base.astro';
import ResultsGrid from '../components/ResultsGrid.astro';
import RecordShelf from '../components/RecordShelf.astro';
import SearchBox from '../components/SearchBox.astro';
import records from '../data/new-arrivals.json';
import subjects from '../data/subjects.json';

const spotlightPayload = JSON.stringify(records).replace(/</g, '\\u003c');
const spotlightFallbacks = records.slice(0, 4);

const subjectCounts = new Map<string, number>();
for (const record of records) {
  for (const subject of record.subjects ?? []) {
    subjectCounts.set(subject, (subjectCounts.get(subject) ?? 0) + 1);
  }
}

let topSubjects = Array.from(subjectCounts.entries())
  .sort((a, b) => {
    if (a[1] === b[1]) return a[0].localeCompare(b[0]);
    return b[1] - a[1];
  })
  .slice(0, 6)
  .map(([subject]) => subject);

if (topSubjects.length < 6) {
  for (const subject of subjects) {
    if (topSubjects.length >= 6) break;
    if (!topSubjects.includes(subject)) topSubjects.push(subject);
  }
}

const uniqueCollections = Array.from(new Set(records.map((record) => record.collection).filter(Boolean)));
const shelves = (uniqueCollections.length ? uniqueCollections : ['Featured volumes']).map((collection, index) => ({
  id: `shelf-${index}-${String(collection).replace(/[^a-z0-9]+/gi, '-').toLowerCase() || 'featured'}`,
  label: `${collection}`,
  records: records.filter((record) => record.collection === collection || uniqueCollections.length === 0)
}));

const stats = [
  { label: 'Records edited', value: records.length },
  { label: 'Collections represented', value: uniqueCollections.length || 1 },
  { label: 'Distinct subjects', value: subjectCounts.size || topSubjects.length }
];
---
<Base>
  <section
    class="hero mx-auto max-w-6xl px-6"
    data-spotlight-root
    data-spotlight-records={spotlightPayload}
  >
    <div class="grid gap-12 lg:grid-cols-[minmax(0,1fr)_420px] lg:items-start">
      <div class="space-y-8">
        <p class="text-sm font-semibold uppercase tracking-[0.35em]" style="color: var(--brand)">
          Waypoint Institute Library Editions
        </p>
        <h1>Explore carefully edited public-domain works.</h1>
        <p>
          Download EPUB/PDF or read online; every record includes provenance, preservation files, and citation helpers so you can
          share with confidence.
        </p>
        <div class="hero__search">
          <SearchBox minimal={false} />
        </div>
        <div class="hero__actions">
          <a href="/browse" class="button">Browse the stacks</a>
          <button type="button" class="button secondary" data-spotlight-shuffle>Shuffle spotlight</button>
        </div>
      </div>
      <aside class="card space-y-6" aria-live="polite">
        <header class="flex items-center justify-between gap-4">
          <h2 class="text-xl font-semibold" style="color: var(--ink)">Spotlight</h2>
          <button type="button" class="button secondary" data-spotlight-shuffle>Shuffle spotlight</button>
        </header>
        <div class="results-grid" data-spotlight-grid role="list">
          {spotlightFallbacks.map((record) => (
            <div role="listitem">
              <RecordCard {...record} />
            </div>
          ))}
        </div>
      </aside>
    </div>
    <div class="mt-16 space-y-16">
      <div class="stat-band" role="list" aria-label="Library snapshot">
        {stats.map((stat) => (
          <div role="listitem">
            <strong>{stat.value.toLocaleString()}</strong>
            <span class="card__meta text-sm">{stat.label}</span>
          </div>
        ))}
      </div>
      {shelves.map((shelf) => (
        <RecordShelf {...shelf} />
      ))}
      <div class="space-y-4">
        <h2 class="text-2xl font-semibold">Browse by subject</h2>
        <div class="flex flex-wrap gap-3">
          {topSubjects.map((subject) => (
            <a class="chip" href={`/search/?subject=${encodeURIComponent(subject)}`}>
              {subject}
            </a>
          ))}
        </div>
      </div>
      <div class="space-y-6">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <h2 class="text-2xl font-semibold">New arrivals</h2>
          <p class="card__meta text-sm">Updated as new editions are published.</p>
        </div>
        <ResultsGrid results={records} />
      </div>
      <ResultsGrid results={records} />
    </div>
  </section>
  <script type="module">
    const STORAGE_KEY = 'waypoint-spotlight';

    const seededOrder = (length, key) => {
      if (!length) return [];
      let seed = 0;
      for (const char of key) {
        seed = (seed * 31 + char.charCodeAt(0)) % 2147483647;
      }
      if (seed === 0) seed = 1;
      const indices = Array.from({ length }, (_, idx) => idx);
      let state = seed;
      for (let i = indices.length - 1; i > 0; i--) {
        state = (state * 1103515245 + 12345) % 2147483647;
        const j = state % (i + 1);
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      return indices;
    };

    const escapeHtml = (value = '') =>
      String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const renderBook = (record) => {
      const title = escapeHtml(record.title ?? 'Untitled');
      const permalink = record.permalink?.startsWith('/')
        ? record.permalink
        : `/${record.permalink ?? ''}`;
      const authors = Array.isArray(record.creators) ? record.creators.filter(Boolean) : [];
      const year = record.year ?? record.date ?? '';
      const collection = record.collection ? escapeHtml(record.collection) : '';
      const subjects = Array.isArray(record.subjects) ? record.subjects.slice(0, 3) : [];
      const cover = record.coverUrl
        ? `<img src="${escapeHtml(record.coverUrl)}" alt="Cover of ${title}" loading="lazy" decoding="async" fetchpriority="low" />`
        : `<div class="book__fallback" aria-hidden="true">${escapeHtml(String(title).slice(0, 1).toUpperCase())}</div>`;
      const authorsLine = authors.length
        ? `${escapeHtml(authors.join(', '))}${year ? '<span class="sep"> Â· </span>' + escapeHtml(String(year)) : ''}`
        : year
        ? `<span class="book__year">${escapeHtml(String(year))}</span>`
        : '';
      const tags = subjects
        .map((subject) => `<span role="listitem" class="chip">${escapeHtml(subject)}</span>`)
        .join('');

      return `
        <article class="book" role="article">
          <a class="book__link" href="${escapeHtml(permalink)}" aria-label="Open record: ${title}">
            <figure class="book__cover">
              ${cover}
              <span class="book__edge" aria-hidden="true"></span>
            </figure>
            <div class="book__meta">
              <h3 class="book__title">${title}</h3>
              ${authorsLine ? `<p class="book__author">${authorsLine}</p>` : ''}
              ${collection ? `<p class="card__meta text-sm" style="margin:0 0 0.4rem">${collection}</p>` : ''}
              ${tags ? `<div class="book__tags" role="list">${tags}</div>` : ''}
            </div>
          </a>
        </article>
      `;
    };

    const initSpotlight = () => {
      const root = document.querySelector('[data-spotlight-root]');
      if (!root) return;
      const grid = root.querySelector('[data-spotlight-grid]');
      if (!grid) return;
      let records = [];
      try {
        records = JSON.parse(root.dataset.spotlightRecords ?? '[]');
      } catch (error) {
        console.warn('Unable to parse spotlight data', error);
        records = [];
      }
      if (!records.length) return;

      const dateKey = new Date().toISOString().slice(0, 10);
      const stored = (() => {
        try {
          const parsed = JSON.parse(window.localStorage.getItem(STORAGE_KEY) ?? 'null');
          if (parsed?.key === dateKey && Array.isArray(parsed.order)) return parsed.order;
        } catch (error) {
          console.warn('Unable to read stored spotlight order', error);
        }
        return null;
      })();
      const order = stored ?? seededOrder(records.length, dateKey);
      if (!stored) {
        try {
          window.localStorage.setItem(STORAGE_KEY, JSON.stringify({ key: dateKey, order }));
        } catch (error) {
          console.warn('Unable to persist spotlight order', error);
        }
      }

      const sliceSize = Math.min(4, order.length);
      let offset = 0;

      const render = () => {
        const selection = [];
        for (let i = 0; i < sliceSize; i++) {
          const index = order[(offset + i) % order.length];
          selection.push(renderBook(records[index] ?? {}));
        }
        grid.innerHTML = selection.map((markup) => `<div role="listitem">${markup}</div>`).join('');
      };

      const advance = () => {
        offset = (offset + sliceSize) % order.length;
        render();
      };

      root.querySelectorAll('[data-spotlight-shuffle]').forEach((button) => {
        button.addEventListener('click', advance);
      });

      render();
    };

    const initShelves = () => {
      document.querySelectorAll('[data-shelf]').forEach((shelf) => {
        const track = shelf.querySelector('[data-shelf-track]');
        const items = Array.from(track?.querySelectorAll('[data-shelf-item]') ?? []);
        if (!track || !items.length) return;
        let index = items.findIndex((item) => item.tabIndex === 0);
        if (index < 0) index = 0;

        const setActive = (nextIndex) => {
          const clamped = Math.max(0, Math.min(nextIndex, items.length - 1));
          if (clamped === index) {
            items[index].scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
            return;
          }
          items[index].tabIndex = -1;
          items[index].setAttribute('aria-selected', 'false');
          index = clamped;
          items[index].tabIndex = 0;
          items[index].setAttribute('aria-selected', 'true');
          items[index].focus();
          items[index].scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
        };

        track.addEventListener('focus', () => {
          if (document.activeElement === track) {
            items[index]?.focus();
          }
        });

        track.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowRight') {
            event.preventDefault();
            setActive(index + 1);
          } else if (event.key === 'ArrowLeft') {
            event.preventDefault();
            setActive(index - 1);
          }
        });

        items.forEach((item, itemIndex) => {
          item.addEventListener('focus', () => {
            items[index].setAttribute('aria-selected', 'false');
            items[index].tabIndex = -1;
            index = itemIndex;
            items[index].tabIndex = 0;
            items[index].setAttribute('aria-selected', 'true');
          });
        });

        const prev = shelf.querySelector('[data-shelf-prev]');
        const next = shelf.querySelector('[data-shelf-next]');
        prev?.addEventListener('click', () => setActive(index - 1));
        next?.addEventListener('click', () => setActive(index + 1));
      });
    };

    const init = () => {
      initSpotlight();
      initShelves();
    };

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      init();
    } else {
      document.addEventListener('DOMContentLoaded', init);
    }
  </script>
</Base>
