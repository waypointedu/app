---
const {
  title,
  creators = [],
  year,
  subjects = [],
  collection,
  quality,
  coverUrl,
  permalink
} = Astro.props as Record<string, any>;

const normalizedPermalink = permalink?.startsWith('/') ? permalink : `/${permalink ?? ''}`;
const headingId = `record-card-${(normalizedPermalink ?? title ?? 'card').replace(/[^a-z0-9]+/gi, '-').toLowerCase()}`;
const metaId = `${headingId}-meta`;
const fallbackInitial = String(title ?? '').trim().slice(0, 1).toUpperCase();
---
<article class="book" role="article">
  <a class="book__link" href={normalizedPermalink} aria-labelledby={headingId} aria-describedby={metaId}>
    <figure class="book__cover">
      {coverUrl ? (
        <img
          src={coverUrl}
          alt={`Cover of ${title}`}
          loading="lazy"
          decoding="async"
          fetchpriority="low"
        />
      ) : (
        <div class="book__fallback" aria-hidden="true">{fallbackInitial}</div>
      )}
      <span class="book__edge" aria-hidden="true"></span>
    </figure>
    <div class="book__meta">
      <h3 id={headingId} class="book__title">
        {title}
      </h3>
      {(creators.length || year) && (
        <p class="book__author" id={metaId}>
          {creators.length ? creators.join(', ') : null}
          {creators.length && year ? <span class="sep"> Â· </span> : null}
          {year ? <span class="book__year">{year}</span> : null}
        </p>
      )}
      {collection ? (
        <p class="card__meta text-sm" style="margin: 0 0 0.4rem">{collection}</p>
      ) : null}
      {subjects.length ? (
        <div class="book__tags" role="list">
          {subjects.slice(0, 3).map((subject) => (
            <span role="listitem" class="chip">
              {subject}
            </span>
          ))}
        </div>
      ) : null}
      {quality ? (
        <span class="chip" aria-label={`Quality grade ${quality}`}>Quality {quality}</span>
      ) : null}
    </div>
  </a>
</article>
